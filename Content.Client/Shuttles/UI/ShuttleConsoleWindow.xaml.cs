using Content.Client.Computer;
using Content.Client.UserInterface.Controls;
using Content.Shared._Lua.Starmap;
using Content.Shared.Shuttles.BUIStates;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Map;
using System.Numerics;

namespace Content.Client.Shuttles.UI;

[GenerateTypedNameReferences]
public sealed partial class ShuttleConsoleWindow : FancyWindow,
    IComputerWindow<ShuttleBoundUserInterfaceState>
{
    [Dependency] private readonly IEntityManager _entManager = default!;

    private ShuttleConsoleMode _mode = ShuttleConsoleMode.Nav;

    public event Action<MapCoordinates, Angle>? RequestFTL;
    public event Action<NetEntity, Angle>? RequestBeaconFTL;
    public event Action<NetEntity?, NetEntity>? RequestTrackEntity; // Frontier
    public event Action<Star>? OnWarpToStarRequest;

    public event Action<NetEntity, NetEntity>? DockRequest;
    public event Action<NetEntity>? UndockRequest;
    public event Action<List<NetEntity>>? UndockAllRequest;
    public event Action<List<NetEntity>, bool>? ToggleFTLLockRequest;
    public event Action<bool>? OnStarMapVisibilityChanged;

    public ShuttleConsoleWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        // Mode switching
        NavModeButton.OnPressed += NavPressed;
        MapModeButton.OnPressed += MapPressed;
        StarMapModeButton.OnPressed += StarMapPressed; // Lua StarMap
        DockModeButton.OnPressed += DockPressed;

        // Modes are exclusive
        var group = new ButtonGroup();

        NavModeButton.Group = group;
        MapModeButton.Group = group;
        StarMapModeButton.Group = group; // Lua StarMap
        DockModeButton.Group = group;

        NavModeButton.Pressed = true;
        SetupMode(_mode);

        MapContainer.RequestFTL += (coords, angle) =>
        {
            RequestFTL?.Invoke(coords, angle);
        };

        MapContainer.RequestBeaconFTL += (ent, angle) =>
        {
            RequestBeaconFTL?.Invoke(ent, angle);
        };

        // Frontier: entity tracking
        MapContainer.RequestTrackEntity += (ent, trackEntity) =>
        {
            RequestTrackEntity?.Invoke(ent, trackEntity);
        };
        // End Frontier

        // Lua start: StarMap
        StarMapContainer.RequestWarpToStar += star =>
        { OnWarpToStarRequest?.Invoke(star); };
        // Lua end: StarMap

        DockContainer.DockRequest += (entity, netEntity) =>
        {
            DockRequest?.Invoke(entity, netEntity);
        };

        DockContainer.UndockRequest += entity =>
        {
            UndockRequest?.Invoke(entity);
        };

        DockContainer.UndockAllRequest += dockEntities =>
        {
            UndockAllRequest?.Invoke(dockEntities);
        };

        DockContainer.ToggleFTLLockRequest += (dockEntities, enabled) =>
        {
            ToggleFTLLockRequest?.Invoke(dockEntities, enabled);
        };

        NfInitialize(); // Frontier Initialization for the ShuttleConsoleWindow
    }

    private void ClearModes(ShuttleConsoleMode mode)
    {
        if (mode != ShuttleConsoleMode.Nav)
        {
            NavContainer.Visible = false;
        }

        if (mode != ShuttleConsoleMode.Map)
        {
            MapContainer.Visible = false;
            MapContainer.SetMap(MapId.Nullspace, Vector2.Zero);
        }

        if (mode != ShuttleConsoleMode.StarMap)
        { StarMapContainer.Visible = false; }

        if (mode != ShuttleConsoleMode.Dock)
        {
            DockContainer.Visible = false;
        }
    }

    private void NavPressed(BaseButton.ButtonEventArgs obj)
    {
        SwitchMode(ShuttleConsoleMode.Nav);
    }

    private void MapPressed(BaseButton.ButtonEventArgs obj)
    {
        SwitchMode(ShuttleConsoleMode.Map);
    }

    private void StarMapPressed(BaseButton.ButtonEventArgs obj)
    { SwitchMode(ShuttleConsoleMode.StarMap); }

    private void DockPressed(BaseButton.ButtonEventArgs obj)
    {
        SwitchMode(ShuttleConsoleMode.Dock);
    }

    private void SetupMode(ShuttleConsoleMode mode)
    {
        switch (mode)
        {
            case ShuttleConsoleMode.Nav:
                NavContainer.Visible = true;
                break;
            case ShuttleConsoleMode.Map:
                MapContainer.Visible = true;
                MapContainer.Startup();
                break;
            case ShuttleConsoleMode.StarMap:
                StarMapContainer.Visible = true;
                StarMapContainer.Startup();
                break;
            case ShuttleConsoleMode.Dock:
                DockContainer.Visible = true;
                break;
            default:
                throw new NotImplementedException();
        }
    }

    public void SwitchMode(ShuttleConsoleMode mode)
    {
        if (_mode == mode)
            return;

        var wasStarMap = _mode == ShuttleConsoleMode.StarMap;
        _mode = mode;
        ClearModes(mode);
        SetupMode(_mode);
        var isStarMap = _mode == ShuttleConsoleMode.StarMap;
        if (wasStarMap != isStarMap) OnStarMapVisibilityChanged?.Invoke(isStarMap);
    }

    public enum ShuttleConsoleMode : byte
    {
        Nav,
        Map,
        StarMap,
        Dock,
    }

    public void UpdateState(EntityUid owner, ShuttleBoundUserInterfaceState cState)
    {
        var coordinates = _entManager.GetCoordinates(cState.NavState.Coordinates);
        NavContainer.SetShuttle(coordinates?.EntityId);
        NavContainer.SetConsole(owner);
        MapContainer.SetShuttle(coordinates?.EntityId);
        MapContainer.SetConsole(owner);
        StarMapContainer.SetShuttle(coordinates?.EntityId);
        StarMapContainer.SetConsole(owner);

        NavContainer.UpdateState(cState.NavState);
        MapContainer.UpdateState(cState.MapState);
        StarMapContainer.UpdateState(cState.StarMapState);
        DockContainer.UpdateState(coordinates?.EntityId, cState.DockState);
    }
}
